name: Cross Compile and Deploy for OpenWrt

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  archs: "aarch64 arm mips mips64 powerpc powerpc64 riscv64 x86_64"
  variants: "basic DHCPv4 UBUS full"

jobs:
  build:
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: aarch64
            gcc: /usr/bin/aarch64-linux-gnu-gcc
            packages: gcc-aarch64-linux-gnu
          - arch: arm
            gcc: /usr/bin/arm-linux-gnueabi-gcc
            packages: gcc-arm-linux-gnueabi
          - arch: mips
            gcc: /usr/bin/mips-linux-gnu-gcc
            packages: gcc-mips-linux-gnu
          - arch: mips64
            gcc: /usr/bin/mips64-linux-gnuabi64-gcc
            packages: gcc-mips64-linux-gnuabi64
          - arch: powerpc
            gcc: /usr/bin/powerpc-linux-gnu-gcc
            packages: gcc-powerpc-linux-gnu
          - arch: powerpc64
            gcc: /usr/bin/powerpc64-linux-gnu-gcc
            packages: gcc-powerpc64-linux-gnu
          - arch: riscv64
            gcc: /usr/bin/riscv64-linux-gnu-gcc
            packages: gcc-riscv64-linux-gnu
          - arch: x86_64
            gcc: /usr/bin/x86_64-linux-gnu-gcc
            packages: gcc-x86-64-linux-gnu

    steps:
      - name: Checkout odhcpd
        uses: actions/checkout@v4

      - name: Checkout json-c
        uses: actions/checkout@v4
        with:
          repository: json-c/json-c
          path: depends/json-c

      - name: Checkout libnl-tiny
        uses: actions/checkout@v4
        with:
          repository: openwrt/libnl-tiny
          path: depends/libnl-tiny

      - name: Checkout libubox
        uses: actions/checkout@v4
        with:
          repository: openwrt/libubox
          path: depends/libubox

      - name: Checkout ubus
        uses: actions/checkout@v4
        with:
          repository: openwrt/ubus
          path: depends/ubus

      - name: Checkout uci
        uses: actions/checkout@v4
        with:
          repository: openwrt/uci
          path: depends/uci

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.packages }}

      - name: Prepare build
        run: |
          mkdir -p ${GITHUB_WORKSPACE}/build

      - name: Build json-c
        working-directory: depends/json-c
        run: |
          cmake \
            -DCMAKE_C_COMPILER=${{ matrix.gcc }} \
            -DCMAKE_PREFIX_PATH=${GITHUB_WORKSPACE}/build \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_STATIC_LIBS=ON \
            -DDISABLE_EXTRA_LIBS=ON \
            -DBUILD_TESTING=OFF \
            --install-prefix ${GITHUB_WORKSPACE}/build \
            -B . -S .
          make
          make install

      - name: Build libnl-tiny
        working-directory: depends/libnl-tiny
        run: |
          sed -i 's/SHARED/STATIC/g' CMakeLists.txt
          cmake \
            -DCMAKE_C_COMPILER=${{ matrix.gcc }} \
            -DCMAKE_PREFIX_PATH=${GITHUB_WORKSPACE}/build \
            --install-prefix ${GITHUB_WORKSPACE}/build \
            -B . -S .
          make
          make install

      - name: Build libubox
        working-directory: depends/libubox
        run: |
          sed -i 's/SHARED/STATIC/g' CMakeLists.txt
          cmake \
            -DCMAKE_C_COMPILER=${{ matrix.gcc }} \
            -DCMAKE_PREFIX_PATH=${GITHUB_WORKSPACE}/build \
            -DBUILD_LUA=OFF \
            -DBUILD_EXAMPLES=OFF \
            --install-prefix ${GITHUB_WORKSPACE}/build \
            -B . -S .
          make
          make install

      - name: Build ubus
        working-directory: depends/ubus
        run: |
          sed -i 's/SHARED/STATIC/g' CMakeLists.txt
          cmake \
            -DCMAKE_C_COMPILER=${{ matrix.gcc }} \
            -DCMAKE_PREFIX_PATH=${GITHUB_WORKSPACE}/build \
            -DBUILD_LUA=OFF \
            -DBUILD_EXAMPLES=OFF \
            --install-prefix ${GITHUB_WORKSPACE}/build \
            -B . -S .
          make
          make install

      - name: Build uci
        working-directory: depends/uci
        run: |
          sed -i 's/SHARED/STATIC/g' CMakeLists.txt
          cmake \
            -DCMAKE_C_COMPILER=${{ matrix.gcc }} \
            -DCMAKE_PREFIX_PATH=${GITHUB_WORKSPACE}/build \
            -DBUILD_LUA=OFF \
            --install-prefix ${GITHUB_WORKSPACE}/build \
            -B . -S .
          make
          make install

      - name: Inspect build directory (Debug)
        run: ls -R ${GITHUB_WORKSPACE}/build

      - id: full
        name: Build odhcpd (full)
        env:
          BUILD_DIR: build/odhcpd-full
        run: |
          cmake \
            -DCMAKE_C_COMPILER=${{ matrix.gcc }} \
            -DCMAKE_PREFIX_PATH=${GITHUB_WORKSPACE}/build \
            -DDHCPV4_SUPPORT=ON \
            -DUBUS=ON \
            -DCMAKE_EXE_LINKER_FLAGS="-static" \
            -DCMAKE_FIND_LIBRARY_SUFFIXES=".a" \
            -B $BUILD_DIR -S .
          make -C $BUILD_DIR
          # Try to strip if the toolchain allows
          STRIP_BIN=$(echo ${{ matrix.gcc }} | sed 's/gcc$/strip/')
          if command -v $STRIP_BIN >/dev/null; then
            $STRIP_BIN $BUILD_DIR/odhcpd
          fi

      - name: Create release archive
        run: |
          cd build/odhcpd-full
          tar -czf odhcpd-${{ matrix.arch }}.tar.gz odhcpd
          mv odhcpd-${{ matrix.arch }}.tar.gz $GITHUB_WORKSPACE/

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: odhcpd-${{ matrix.arch }}-release
          path: odhcpd-${{ matrix.arch }}.tar.gz

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: odhcpd-*-release
          path: artifacts
      
      - name: Display structure of downloaded files
        run: ls -R artifacts
      
      - name: Get commit info
        id: commit_info
        run: |
          echo "COMMIT_TIME=$(git show -s --format=%ci ${{ github.sha }})" >> $GITHUB_OUTPUT
          echo "COMMIT_MESSAGE=$(git show -s --format=%s ${{ github.sha }})" >> $GITHUB_OUTPUT
          echo "COMMIT_AUTHOR=$(git show -s --format=%an ${{ github.sha }})" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          draft: false
          prerelease: false
          body: |
            odhcpd è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
            
            ğŸ“… æ„å»ºæ—¶é—´: ${{ steps.commit_info.outputs.COMMIT_TIME }}
            ğŸ“ æäº¤ä¿¡æ¯: ${{ steps.commit_info.outputs.COMMIT_MESSAGE }}
            ğŸ‘¤ æäº¤è€…: ${{ steps.commit_info.outputs.COMMIT_AUTHOR }}
            ğŸ”¢ è¿è¡Œç¼–å·: #${{ github.run_number }}
            
            ## ğŸ“¦ åŒ…å«æ¶æ„
            - aarch64, arm, mips, mips64, powerpc, riscv64, x86_64
            
            ## ğŸš€ å¿«é€Ÿå®‰è£…
            ä¸‹è½½å¯¹åº”æ¶æ„çš„ `odhcpd-ARCH.tar.gz`ï¼Œè§£å‹å¹¶æ›¿æ¢ `/usr/sbin/odhcpd`ã€‚
            
            æ³¨æ„ï¼šæ­¤ç‰ˆæœ¬ä½¿ç”¨ GNU å·¥å…·é“¾ç¼–è¯‘ï¼Œå¯èƒ½éœ€è¦ç›®æ ‡ç³»ç»Ÿæ”¯æŒ glibc æˆ–å…·æœ‰ç›¸åº”çš„å…¼å®¹åº“ã€‚
          files: |
            artifacts/**/*.tar.gz

  notify:
    needs: [build, deploy]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Notify deployment status
        run: |
          if [[ "${{ needs.build.result }}" == "success" && "${{ needs.deploy.result }}" == "success" ]]; then
            echo "âœ… æ„å»ºå’Œéƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸ“¦ æ–°ç‰ˆæœ¬å·²å‘å¸ƒ: v${{ github.run_number }}"
            echo "ğŸ”— ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/v${{ github.run_number }}"
          else
            echo "âŒ æ„å»ºæˆ–éƒ¨ç½²å¤±è´¥"
            echo "è¯·æ£€æŸ¥GitHub Actionsæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
          fi
